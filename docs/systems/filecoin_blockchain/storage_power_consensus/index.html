<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Storage Power Consensus | Filecoin Spec</title>



<link rel="stylesheet" href="../../../../book.min.cc8a7af7caa5a1f2d6cb09b76c451c38ff26f98a05f07f81e81723e47f8f3ef8.css">
<link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=EB+Garamond" />


<link rel="icon" href="../../../../favicon.png" type="image/x-icon">


<link rel="alternate" type="application/rss+xml" href="../../../../docs/systems/filecoin_blockchain/storage_power_consensus/index.xml" title="Filecoin Spec" />

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/javascript" src="./gumshoe.polyfills.min.js"></script>

<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  <link rel="stylesheet" href="../../../../css/syntax.css">
<link href="../../../../mermaid/mermaid.css" type="text/css" rel="stylesheet" />
<script src="../../../../mermaid/mermaid.js"></script>
<script src="../../../../spec.js"></script>

</head>

<body>
  <input type="checkbox" class="hidden" id="menu-control" />
  <main class="flex container">

    <aside class="book-menu fixed">
      <nav>
<h2 class="book-brand">
  <a href=""><span>Filecoin Spec</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" placeholder="Search" id="book-search-input" maxlength="64" readonly />
  <div class="book-search-spinner spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>





    
  
  
  

  <style>
  nav ul a[href$="\2f docs\2fsystems\2f filecoin_blockchain\2fstorage_power_consensus\2f "] {
      color: #0b3a53;
  }
  </style>


  <div id="menu-toc">

  <div>
    
    <input id="menu-detail-slider" type="range" onchange="onMenuDetailChange();"
      min="1" value="3" max="5" step="1" />

    <span id="menu-detail-slider-label">3</span>
  </div>

  
  
  <ul class="menu-item-section depth-0">
  
      <li>
      
        











<a href="../../../../#intro" class="menu-item depth-1">
    
    
    <strong>
    
        Introduction
    
    </strong>
    
</a>



<ul class="menu-item-section depth-1">

    <li>
    
      











<a href="../../../../#intro__arch" class="menu-item depth-2">
    
    
        Architecture Diagrams
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#intro__concepts" class="menu-item depth-2">
    
    
        Key Concepts
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#intro__filecoin_vm" class="menu-item depth-2">
    
    
        Filecoin VM
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#intro__process" class="menu-item depth-2">
    
    
        Process
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      










  


<a href="../../../../#intro__process__about" class="menu-item depth-3">
    
    
        About
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#intro__process__fip" class="menu-item depth-3">
    
    
        FIPs
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#intro__process__contributing" class="menu-item depth-3">
    
    
        Contributing
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#intro__process__related_resources" class="menu-item depth-3">
    
    
        Related Resources
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      











<a href="../../../../#intro__process__related_resources__research_portal" class="menu-item depth-4">
    
    
        Research portal
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#intro__process__related_resources__network_tooling" class="menu-item depth-4">
    
    
        Network tooling
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#intro__process__related_resources__testing" class="menu-item depth-4">
    
    
        Testing and implementation compliance
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#intro__changelog" class="menu-item depth-2">
    
    
        Change Log
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#intro__system" class="menu-item depth-2">
    
    
        System Decomposition
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      










  


<a href="../../../../#intro__system__why_systems" class="menu-item depth-3">
    
    
        What are Systems?
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#intro__system__impl_systems" class="menu-item depth-3">
    
    
        Implementing Systems
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

</ul>


    
    </li>

</ul>


      
      </li>
  
      <li>
      
        











<a href="../../../../#systems" class="menu-item depth-1">
    
    
    <strong>
    
        Systems
    
    </strong>
    
</a>



<ul class="menu-item-section depth-1">

    <li>
    
      











<a href="../../../../#systems__filecoin_nodes" class="menu-item depth-2">
    ‚öôÔ∏è
    
        <strong>Filecoin Nodes</strong>
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      











<a href="../../../../#systems__filecoin_nodes__node_types" class="menu-item depth-3">
    
    
        Node Types
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      











<a href="../../../../#systems__filecoin_nodes__node_types__node" class="menu-item depth-4">
    
    
        Node Interface
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_nodes__node_types__node_types" class="menu-item depth-4">
    
    
        Examples
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_nodes__node_types__verifier_node" class="menu-item depth-4">
    
    
        Chain Verifier Node
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_nodes__node_types__client_node" class="menu-item depth-4">
    
    
        Client Node
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_nodes__node_types__storage_miner_node" class="menu-item depth-4">
    
    
        Storage Miner Node
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_nodes__node_types__retrieval_miner_node" class="menu-item depth-4">
    
    
        Retrieval Miner Node
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_nodes__node_types__relayer_node" class="menu-item depth-4">
    
    
        Relayer Node
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#systems__filecoin_nodes__repository" class="menu-item depth-3">
    
    
        Repository
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      










  


<a href="../../../../#systems__filecoin_nodes__repository__config" class="menu-item depth-4">
    
    
        Config
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_nodes__repository__key_store" class="menu-item depth-4">
    
    
        Key Store
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#systems__filecoin_nodes__repository__ipldstore" class="menu-item depth-4">
    
    
        IpldStore
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_nodes__network" class="menu-item depth-3">
    
    
        Network Interface
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_nodes__clock" class="menu-item depth-3">
    
    
        Clock
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#systems__filecoin_files" class="menu-item depth-2">
    üìë
    
        <strong>Files &amp; Data</strong>
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      











<a href="../../../../#systems__filecoin_files__file" class="menu-item depth-3">
    
    
        File
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      










  


<a href="../../../../#systems__filecoin_files__file__filestore" class="menu-item depth-4">
    
    
        FileStore
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#systems__filecoin_files__piece" class="menu-item depth-3">
    
    
        Piece
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      










  


<a href="../../../../#systems__filecoin_files__piece__piece_store" class="menu-item depth-4">
    
    
        PieceStore
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#systems__filecoin_files__data_transfer" class="menu-item depth-3">
    
    
        Data Transfer
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#systems__filecoin_files__serialization" class="menu-item depth-3">
    
    
        Formats and Serialization
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#systems__filecoin_vm" class="menu-item depth-2">
    üíª
    
        <strong>Virtual Machine</strong>
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      










  


<a href="../../../../#systems__filecoin_vm__actor" class="menu-item depth-3">
    
    
        Actor
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
    </li>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_vm__state_tree" class="menu-item depth-3">
    
    
        State Tree
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#systems__filecoin_vm__indices" class="menu-item depth-3">
    
    
        Indices
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#systems__filecoin_vm__message" class="menu-item depth-3">
    
    
        Message
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#systems__filecoin_vm__runtime" class="menu-item depth-3">
    
    
        Runtime
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
    </li>

    <li>
    
      










  


<a href="../../../../#systems__filecoin_vm__runtime__gascost" class="menu-item depth-4">
    
    
        Gas Costs
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_vm__sysactors" class="menu-item depth-3">
    
    
        System Actors
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      











<a href="../../../../#systems__filecoin_vm__sysactors__init_actor" class="menu-item depth-4">
    
    
        InitActor
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_vm__sysactors__cron_actor" class="menu-item depth-4">
    
    
        CronActor
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_vm__sysactors__account_actor" class="menu-item depth-4">
    
    
        AccountActor
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_vm__sysactors__reward_actor" class="menu-item depth-4">
    
    
        RewardActor
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#systems__filecoin_vm__interpreter" class="menu-item depth-3">
    
    
        Interpreter
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_blockchain" class="menu-item depth-2">
    üì¶
    
        <strong>Blockchain</strong>
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      











<a href="../../../../#systems__filecoin_blockchain__struct" class="menu-item depth-3">
    
    
        Blocks
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      











<a href="../../../../#systems__filecoin_blockchain__struct__block" class="menu-item depth-4">
    
    
        Block
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_blockchain__struct__tipset" class="menu-item depth-4">
    
    
        Tipset
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_blockchain__struct__chain" class="menu-item depth-4">
    
    
        Chain
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_blockchain__struct__chain_manager" class="menu-item depth-4">
    
    
        Chain Manager
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_blockchain__struct__block_producer" class="menu-item depth-4">
    
    
        Block Producer
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_blockchain__message_pool" class="menu-item depth-3">
    
    
        Message Pool
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      











<a href="../../../../#systems__filecoin_blockchain__message_pool__message_syncer" class="menu-item depth-4">
    
    
        Message Syncer
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_blockchain__message_pool__message_storage" class="menu-item depth-4">
    
    
        Message Storage
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
    </li>

    <li>
    
      










  


<a href="../../../../#systems__filecoin_blockchain__chainsync" class="menu-item depth-3">
    
    
        ChainSync
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_blockchain__storage_power_consensus" class="menu-item depth-3">
    
    
        Storage Power Consensus
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      











<a href="../../../../#systems__filecoin_blockchain__storage_power_consensus__storage_power_actor" class="menu-item depth-4">
    
    
        Storage Power Actor
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_token" class="menu-item depth-2">
    üìÄ
    
        <strong>Token</strong>
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      










  


<a href="../../../../#systems__filecoin_token__wallets" class="menu-item depth-3">
    
    
        Wallet
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#systems__filecoin_token__payment_channels" class="menu-item depth-3">
    
    
        Payment Channels
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      











<a href="../../../../#systems__filecoin_token__payment_channels__payment_channel_actor" class="menu-item depth-4">
    
    
        Payment Channel Actor
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#systems__filecoin_token__multisig" class="menu-item depth-3">
    
    
        Multisig Wallet
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      











<a href="../../../../#systems__filecoin_token__multisig__multisig_actor" class="menu-item depth-4">
    
    
        Multisig Actor
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#systems__filecoin_mining" class="menu-item depth-2">
    ‚õè
    
        <strong>Storage Mining</strong>
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      










  


<a href="../../../../#systems__filecoin_mining__storage_mining" class="menu-item depth-3">
    
    
        Storage Miner
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      











<a href="../../../../#systems__filecoin_mining__storage_mining__mining_cycle" class="menu-item depth-4">
    
    
        Storage Mining Cycle
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_mining__storage_mining__storage_miner_actor" class="menu-item depth-4">
    
    
        Storage Miner Actor
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_mining__sector" class="menu-item depth-3">
    
    
        Sector
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      











<a href="../../../../#systems__filecoin_mining__sector__lifecycle" class="menu-item depth-4">
    
    
        Sector Lifecycle
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_mining__sector__sectorset" class="menu-item depth-4">
    
    
        Sector Set
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_mining__sector__posting" class="menu-item depth-4">
    
    
        Sector PoSting
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_mining__sector__sealing" class="menu-item depth-4">
    
    
        Sector Sealing
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_mining__sector_index" class="menu-item depth-3">
    
    
        Sector Index
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
    </li>

    <li>
    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_mining__sector_index__sector_builder" class="menu-item depth-4">
    
    
        Sector Builder
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_mining__sector_index__sector_store" class="menu-item depth-4">
    
    
        SectorStore
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_mining__storage_proving" class="menu-item depth-3">
    
    
        Storage Proving
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      










  


<a href="../../../../#systems__filecoin_mining__storage_proving__sealer" class="menu-item depth-4">
    
    
        Sector Sealer
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#systems__filecoin_mining__storage_proving__poster" class="menu-item depth-4">
    
    
        Sector Poster
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#systems__filecoin_markets" class="menu-item depth-2">
    ‚öñÔ∏è
    
        <strong>Market</strong>
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      










  


<a href="../../../../#systems__filecoin_markets__storage_market" class="menu-item depth-3">
    
    
        Storage Market
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      










  


<a href="../../../../#systems__filecoin_markets__storage_market__storage_deal" class="menu-item depth-4">
    
    
        Storage Deal
    
</a>



<ul class="menu-item-section depth-4">

    <li>
    
      










  


<a href="../../../../#systems__filecoin_markets__storage_market__storage_deal__storage_deal_flow" class="menu-item depth-5">
    
    
        Deal Flow
    
</a>



<ul class="menu-item-section depth-5">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#systems__filecoin_markets__storage_market__storage_deal__storage_deal_states" class="menu-item depth-5">
    
    
        Deal States
    
</a>



<ul class="menu-item-section depth-5">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_markets__storage_market__storage_deal__faults" class="menu-item depth-5">
    
    
        Faults
    
</a>



<ul class="menu-item-section depth-5">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_markets__storage_market__storage_market_actor" class="menu-item depth-4">
    
    
        Storage Market Actor
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_markets__storage_market__storage_provider" class="menu-item depth-4">
    
    
        Storage Provider
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_markets__storage_market__storage_client" class="menu-item depth-4">
    
    
        Storage Client
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#systems__filecoin_markets__retrieval_market" class="menu-item depth-3">
    
    
        Retrieval Market
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      











<a href="../../../../#systems__filecoin_markets__retrieval_market__retrieval_peer_resolver" class="menu-item depth-4">
    
    
        Retrieval Peer Resolver
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_markets__retrieval_market__retrieval_protocols" class="menu-item depth-4">
    
    
        Retrieval Protocols
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_markets__retrieval_market__retrieval_client" class="menu-item depth-4">
    
    
        Retrieval Client
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_markets__retrieval_market__retrieval_provider" class="menu-item depth-4">
    
    
        Retrieval Provider (Miner)
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

</ul>


    
    </li>

</ul>


      
      </li>
  
      <li>
      
        










  


<a href="../../../../#libraries" class="menu-item depth-1">
    
    
    <strong>
    
        Libraries
    
    </strong>
    
</a>



<ul class="menu-item-section depth-1">

    <li>
    
      










  


<a href="../../../../#libraries__filcrypto" class="menu-item depth-2">
    
    
        Filcrypto
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      










  


<a href="../../../../#libraries__filcrypto__filproofs" class="menu-item depth-3">
    
    
        filproofs
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#libraries__fcs" class="menu-item depth-2">
    
    
        FCS
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#libraries__ipld" class="menu-item depth-2">
    
    
        IPLD
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      










  


<a href="../../../../#libraries__ipld__cid" class="menu-item depth-3">
    
    
        CID
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#libraries__ipld__datamodel" class="menu-item depth-3">
    
    
        Data Model
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#libraries__ipld__selectors" class="menu-item depth-3">
    
    
        Selectors
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#libraries__libp2p" class="menu-item depth-2">
    
    
        libp2p
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      










  


<a href="../../../../#libraries__libp2p__gossipsub" class="menu-item depth-3">
    
    
        gossipsub
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#libraries__libp2p__kad_dht" class="menu-item depth-3">
    
    
        kad-dht
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#libraries__libp2p__fil_libp2p_nodes" class="menu-item depth-3">
    
    
        fil-libp2p Nodes
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#libraries__ipfs" class="menu-item depth-2">
    
    
        IPFS
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      











<a href="../../../../#libraries__ipfs__bitswap" class="menu-item depth-3">
    
    
        BitSwap
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#libraries__ipfs__graphsync" class="menu-item depth-3">
    
    
        GraphSync
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#libraries__ipfs__unixfs" class="menu-item depth-3">
    
    
        UnixFS
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#libraries__multiformats" class="menu-item depth-2">
    
    
        Multiformats
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

</ul>


      
      </li>
  
      <li>
      
        











<a href="../../../../#algorithms" class="menu-item depth-1">
    
    
    <strong>
    
        Algorithms
    
    </strong>
    
</a>



<ul class="menu-item-section depth-1">

    <li>
    
      











<a href="../../../../#algorithms__expected_consensus" class="menu-item depth-2">
    
    
        Expected Consensus
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#algorithms__porep" class="menu-item depth-2">
    
    
        Proof-of-Replication
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      











<a href="../../../../#algorithms__porep__stacked_drg" class="menu-item depth-3">
    
    
        Stacked DRG PoRep
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#algorithms__porep__porep_commitments" class="menu-item depth-3">
    
    
        PoRep Commitments
    
</a>




    
    </li>

    <li>
    
      











<a href="../../../../#algorithms__porep__stacked_drg_circuit" class="menu-item depth-3">
    
    
        Stacked DRG - Offline PoRep Circuit Spec
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#algorithms__post" class="menu-item depth-2">
    
    
        Proof-of-Spacetime
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      











<a href="../../../../#algorithms__post__election_post" class="menu-item depth-3">
    
    
        Election PoSt
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#algorithms__post__proof_of_spacetime_parameters" class="menu-item depth-3">
    
    
        PoSt Parameters
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#algorithms__payment_channels" class="menu-item depth-2">
    
    
        Payment Channels
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#algorithms__block_sync" class="menu-item depth-2">
    
    
        BlockSync
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#algorithms__gossip_sub" class="menu-item depth-2">
    
    
        GossipSub
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#algorithms__crypto" class="menu-item depth-2">
    
    
        Cryptographic Primitives
    
</a>




    
    </li>

    <li>
    
      










  


<a href="../../../../#algorithms__cryptoecon" class="menu-item depth-2">
    
    
        Cryptoecon
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

</ul>


      
      </li>
  
      <li>
      
        











<a href="../../../../#listings" class="menu-item depth-1">
    
    
    <strong>
    
        Listings
    
    </strong>
    
</a>



<ul class="menu-item-section depth-1">

    <li>
    
      











<a href="../../../../#listings__actors" class="menu-item depth-2">
    
    
        Filecoin VM Actors
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#listings__reserved_ranges" class="menu-item depth-2">
    
    
        Reserved Ranges
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#listings__data_structures" class="menu-item depth-2">
    
    
        Data Structures
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#listings__system_map" class="menu-item depth-2">
    
    
        Components
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#listings__libp2p_protocols" class="menu-item depth-2">
    
    
        libp2p Protocols
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      











<a href="../../../../#listings__libp2p_protocols__data_transfer_protocol" class="menu-item depth-3">
    
    
        Data Transfer Protocol
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

</ul>


    
    </li>

</ul>


      
      </li>
  
      <li>
      
        











<a href="../../../../#glossary" class="menu-item depth-1">
    
    
    <strong>
    
        Glossary
    
    </strong>
    
</a>



<ul class="menu-item-section depth-1">

</ul>


      
      </li>
  
      <li>
      
        











<a href="../../../../#appendix" class="menu-item depth-1">
    
    
    <strong>
    
        Appendix
    
    </strong>
    
</a>



<ul class="menu-item-section depth-1">

    <li>
    
      











<a href="../../../../#appendix__sharray" class="menu-item depth-2">
    
    
        Sharded IPLD Array
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#appendix__address" class="menu-item depth-2">
    
    
        Address
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#appendix__network_params" class="menu-item depth-2">
    
    
        Filecoin Parameters
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

</ul>


      
      </li>
  
  </ul>
  
</div>










</nav>


<script>
(function() {
  var menu = document.querySelector("aside.book-menu nav");
  addEventListener("beforeunload", function(event) {
    localStorage.setItem("menu.scrollTop", menu.scrollTop);
  });
  menu.scrollTop = localStorage.getItem("menu.scrollTop");
})();
</script>

    </aside>

    <div class="book-page">
      <header class="flex align-center justify-between book-header">
  <label for="menu-control">
    <img src="../../../../svg/menu.svg" alt="Menu" />
  </label>
  <strong>Storage Power Consensus</strong>
</header>

      
<article class="markdown"><p><div id="systems__filecoin_blockchain__storage_power_consensus__storage_power_consensus"></div>
The Storage Power Consensus subsystem is the main interface which enables Filecoin nodes to agree on the state of the system. SPC accounts for individual storage miners&rsquo; effective power over consensus in given chains in its <a href="../../../../#systems__filecoin_blockchain__storage_power_consensus__storage_power_actor__power_table">Power Table</a>. It also runs <a href="../../../../#algorithms__expected_consensus___index">Expected Consensus</a> (the underlying consensus algorithm in use by Filecoin), enabling storage miners to run leader election and generate new blocks updating the state of the Filecoin system.</p>
<p>Succinctly, the SPC subsystem offers the following services:</p>
<ul>
<li>
<p>Access to the <a href="../../../../#systems__filecoin_blockchain__storage_power_consensus__storage_power_actor__power_table">Power Table</a> for every subchain, accounting for individual storage miner power and total power on-chain.</p>
</li>
<li>
<p>Access to <a href="../../../../#algorithms__expected_consensus___index">Expected Consensus</a> for individual storage miners, enabling:</p>
<ul>
<li>Access to verifiable randomness <a href="../../../../#systems__filecoin_blockchain__storage_power_consensus__tickets">Tickets</a> as needed in the rest of the protocol.</li>
<li>Running  <a href="../../../../#algorithms__expected_consensus__leader_election">Secret Leader Election</a> to produce new blocks.</li>
<li>Running <a href="../../../../#algorithms__expected_consensus__chain_selection">Chain Selection</a> across subchains using EC&rsquo;s weighting function.</li>
<li>Identification of <a href="../../../../#algorithms__expected_consensus__finality">the most recently finalized tipset</a>, for use by all protocol participants.</li>
</ul>
</li>
</ul>
<p>Much of the Storage Power Consensus&rsquo; subsystem functionality is detailed in the code below but we touch upon some of its behaviors in more detail.</p>



















<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="nx">abi</span> <span class="s">&#34;github.com/filecoin-project/specs-actors/actors/abi&#34;</span>
<span class="kn">import</span> <span class="nx">addr</span> <span class="s">&#34;github.com/filecoin-project/go-address&#34;</span>
<span class="kn">import</span> <span class="nx">block</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_blockchain/struct/block&#34;</span>
<span class="kn">import</span> <span class="nx">chain</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_blockchain/struct/chain&#34;</span>
<span class="kn">import</span> <span class="nx">st</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_vm/state_tree&#34;</span>
<span class="kn">import</span> <span class="nx">filcrypto</span> <span class="s">&#34;github.com/filecoin-project/specs/algorithms/crypto&#34;</span>
<span class="kn">import</span> <span class="nx">blockchain</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_blockchain&#34;</span>
<span class="kn">import</span> <span class="nx">spowact</span> <span class="s">&#34;github.com/filecoin-project/specs-actors/actors/builtin/storage_power&#34;</span>
<span class="kn">import</span> <span class="nx">node_base</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_nodes/node_base&#34;</span>

<span class="kd">type</span> <span class="nx">StoragePowerConsensusSubsystem</span> <span class="kd">struct</span> <span class="p">{</span><span class="c1">//(@mutable)
</span><span class="c1"></span>    <span class="nf">ChooseTipsetToMine</span><span class="p">(</span><span class="nx">tipsets</span> <span class="p">[</span><span class="nx">chain</span><span class="p">.</span><span class="nx">Tipset</span><span class="p">])</span> <span class="p">[</span><span class="nx">chain</span><span class="p">.</span><span class="nx">Tipset</span><span class="p">]</span>

    <span class="nx">node</span>        <span class="nx">node_base</span><span class="p">.</span><span class="nx">FilecoinNode</span>
    <span class="nx">ec</span>          <span class="nx">ExpectedConsensus</span>
    <span class="nx">blockchain</span>  <span class="nx">blockchain</span><span class="p">.</span><span class="nx">BlockchainSubsystem</span>

    <span class="c1">// call by BlockchainSubsystem during block reception
</span><span class="c1"></span>    <span class="nf">ValidateBlock</span><span class="p">(</span><span class="nx">block</span> <span class="nx">block</span><span class="p">.</span><span class="nx">Block</span><span class="p">)</span> <span class="kt">error</span>

    <span class="nf">IsWinningPartialTicket</span><span class="p">(</span>
        <span class="nx">st</span>                 <span class="nx">st</span><span class="p">.</span><span class="nx">StateTree</span>
        <span class="nx">partialTicket</span>      <span class="nx">abi</span><span class="p">.</span><span class="nx">PartialTicket</span>
        <span class="nx">sectorUtilization</span>  <span class="nx">abi</span><span class="p">.</span><span class="nx">StoragePower</span>
        <span class="nx">numSectors</span>         <span class="nx">util</span><span class="p">.</span><span class="nx">UVarint</span>
    <span class="p">)</span> <span class="kt">bool</span>

    <span class="nf">_getStoragePowerActorState</span><span class="p">(</span><span class="nx">stateTree</span> <span class="nx">st</span><span class="p">.</span><span class="nx">StateTree</span><span class="p">)</span> <span class="nx">spowact</span><span class="p">.</span><span class="nx">StoragePowerActorState</span>

    <span class="nf">validateTicket</span><span class="p">(</span>
        <span class="nx">tix</span>             <span class="nx">block</span><span class="p">.</span><span class="nx">Ticket</span>
        <span class="nx">pk</span>              <span class="nx">filcrypto</span><span class="p">.</span><span class="nx">VRFPublicKey</span>
        <span class="nx">minerActorAddr</span>  <span class="nx">addr</span><span class="p">.</span><span class="nx">Address</span>
    <span class="p">)</span> <span class="kt">bool</span>

    <span class="nf">computeChainWeight</span><span class="p">(</span><span class="nx">tipset</span> <span class="nx">chain</span><span class="p">.</span><span class="nx">Tipset</span><span class="p">)</span> <span class="nx">block</span><span class="p">.</span><span class="nx">ChainWeight</span>

    <span class="nf">StoragePowerConsensusError</span><span class="p">()</span> <span class="nx">StoragePowerConsensusError</span>

    <span class="nf">GetFinalizedEpoch</span><span class="p">(</span><span class="nx">currentEpoch</span> <span class="nx">abi</span><span class="p">.</span><span class="nx">ChainEpoch</span><span class="p">)</span> <span class="nx">abi</span><span class="p">.</span><span class="nx">ChainEpoch</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">StoragePowerConsensusError</span> <span class="kd">struct</span> <span class="p">{}</span>
</code></pre></div>





<h2 id="distinguishing-between-storage-miners-and-block-miners">Distinguishing between storage miners and block miners</h2>
<p>There are two ways to earn Filecoin tokens in the Filecoin network:</p>
<ul>
<li>By participating in the <a href="../../../../#systems__filecoin_markets__storage_market___index">Storage Market</a> as a storage provider and being paid by clients for file storage deals.</li>
<li>By mining new blocks on the network, helping modify system state and secure the Filecoin consensus mechanism.</li>
</ul>
<p>We must distinguish between both types of &ldquo;miners&rdquo; (storage and block miners). <a href="../../../../#algorithms__expected_consensus__leader_election">Secret Leader Election</a> in Filecoin is predicated on a miner&rsquo;s storage power. Thus, while all block miners will be storage miners, the reverse is not necessarily true.</p>
<p>However, given Filecoin&rsquo;s &ldquo;useful Proof-of-Work&rdquo; is achieved through file storage (PoRep and PoSt), there is little overhead cost for storage miners to participate in leader election. Such a <a href="../../../../#systems__filecoin_mining__storage_mining__storage_miner_actor">Storage Miner Actor</a> need only register with the <a href="../../../../#systems__filecoin_blockchain__storage_power_consensus__storage_power_actor">Storage Power Actor</a> in order to participate in Expected Consensus and mine blocks.</p>
<div id="systems__filecoin_blockchain__storage_power_consensus__storage_power"></div>
<h2 id="on-power">On Power</h2>
<p>Claimed power is assigned to every sector as a static function of its <code>SectorStorageWeightDesc</code> which includes <code>SectorSize</code>, <code>Duration</code>, and <code>DealWeight</code>. DealWeight is a measure that maps size and duration of active deals in a sector during its lifetime to its impact on power and reward distribution. A CommittedCapacity Sector (see <a href="../../../../#systems__filecoin_mining__storage_mining">Sector Types</a>) will have a DealWeight of zero but all sectors have an explicit Duration which is defined from the ChainEpoch that the sector comes online in a ProveCommit message to the Expiration ChainEpoch of the sector. In principle, power is the number of votes a miner has in leader election and it is a point in time concept of storage. However, the exact function that maps <code>SectorStorageWeightDesc</code> to claimed <code>StoragePower</code> and <code>BlockReward</code> will be announced soon.</p>
<p>More precisely,</p>
<ul>
<li>Claimed power = power from ProveCommit sectors minus sectors in TemporaryFault effective duration.</li>
<li>Nominal power = claimed power, unless the miner is in DetectedFault or Challenged state. Nominal power is used to determine total network storage power for purposes of consensus minimum.</li>
<li>Consensus power = nominal power, unless the miner fails to meet consensus minimum, or is undercollateralized.</li>
</ul>
<div id="systems__filecoin_blockchain__storage_power_consensus__tickets"></div>
<h2 id="tickets">Tickets</h2>
<p>Tickets are used across the Filecoin protocol as sources of randomness:</p>
<ul>
<li>The <a href="../../../../#systems__filecoin_mining__storage_proving__sector_sealer">Sector Sealer</a> uses tickets as SealSeeds to bind sector commitments to a given subchain.</li>
<li>The <a href="../../../../#systems__filecoin_mining__storage_mining">Storage Miner</a> likewise uses tickets as PoStChallenges to prove sectors remain committed as of a given block.</li>
<li>They are drawn by the Storage Power subsystem as randomness in <a href="../../../../#algorithms__expected_consensus__leader_election">Secret Leader Election</a> to determine their eligibility to mine a block</li>
<li>They are drawn by the Storage Power subsystem in order to generate new tickets for future use.</li>
</ul>
<p>Each of these ticket uses may require drawing tickets at different chain epochs, according to the security requirements of the particular protocol making use of tickets. Specifically, the ticket Digest (which is a Blake2b output) is used for randomness.</p>
<p>In Filecoin, every block header contains a single ticket.</p>
<p>You can find the Ticket data structure <a href="../../../../#listings__data_structures">here</a>.</p>
<h3 id="comparing-tickets-in-a-tipset-and-using-ticket-values">Comparing Tickets in a Tipset and using ticket values</h3>
<p>Whenever comparing tickets is evoked in Filecoin, for instance when discussing selecting the &ldquo;min ticket&rdquo; in a Tipset, the comparison is that of the ticket&rsquo;s VRFDigest&rsquo;s bytes.</p>
<p>Likewise any use of a ticket&rsquo;s value, is that of its VRFDigest&rsquo;s bytes.</p>
<div id="systems__filecoin_blockchain__storage_power_consensus__ticket_chain"></div>
<h2 id="the-ticket-chain-and-drawing-randomness">The Ticket chain and drawing randomness</h2>
<p>While each Filecoin block header contains a ticket field (see <a href="../../../../#systems__filecoin_blockchain__storage_power_consensus__tickets">Tickets</a>), it is useful to think of a ticket chain abstraction.
Due to the nature of Filecoin&rsquo;s Tipsets and the possibility of using tickets from epochs that did not yield leaders to produce randomness at a given epoch, tracking the canonical ticket of a subchain at a given height can be arduous to reason about in terms of blocks. To that end, it is helpful to create a ticket chain abstraction made up of only those tickets to be used for randomness generation at a given height.</p>
<p>To read more about specifically how tickets are processed for randomness, see <a href="../../../../#algorithms__crypto__randomness">Randomness</a>.</p>
<div id="systems__filecoin_blockchain__storage_power_consensus__ticket_generation"></div>
<h3 id="randomness-ticket-generation">Randomness Ticket generation</h3>
<p>This section discusses how tickets are generated by EC for the <code>Ticket</code> field in every block header.</p>
<p>At round <code>N</code>, a new ticket is generated using tickets drawn from the Tipset at round <code>N-1</code> (as shown below).</p>
<p>The miner runs the prior ticket through a Verifiable Random Function (VRF) to get a new unique ticket which can later be derived for randomness (as shown above). The prior ticket is prepended with the ticket domain separation tag and concatenated with the miner actor address (to ensure miners using the same worker keys get different randomness).</p>
<p>To generate a ticket for a given epoch n:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">LastTicket = MinTicketValueAtEpoch(n-1)
newRandomness = VRF_miner(H(TicketProdDST || index || Serialization(pastTicket, minerActorAddress)))
</code></pre></div><p>The VRF&rsquo;s deterministic output adds entropy to the ticket chain, limiting a miner&rsquo;s ability to alter one block to influence a future ticket (given a miner does not know who will win a given round in advance).</p>
<p>We use the VRF from <a href="../../../../#algorithms__crypto__vrf">Verifiable Random Function</a> for ticket generation in EC (see the <code>PrepareNewTicket</code> method below).</p>



















<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">storage_mining</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="nx">addr</span> <span class="s">&#34;github.com/filecoin-project/go-address&#34;</span>
	<span class="nx">abi</span> <span class="s">&#34;github.com/filecoin-project/specs-actors/actors/abi&#34;</span>
	<span class="nx">builtin</span> <span class="s">&#34;github.com/filecoin-project/specs-actors/actors/builtin&#34;</span>
	<span class="nx">smarkact</span> <span class="s">&#34;github.com/filecoin-project/specs-actors/actors/builtin/storage_market&#34;</span>
	<span class="nx">sminact</span> <span class="s">&#34;github.com/filecoin-project/specs-actors/actors/builtin/storage_miner&#34;</span>
	<span class="nx">spowact</span> <span class="s">&#34;github.com/filecoin-project/specs-actors/actors/builtin/storage_power&#34;</span>
	<span class="nx">acrypto</span> <span class="s">&#34;github.com/filecoin-project/specs-actors/actors/crypto&#34;</span>
	<span class="nx">indices</span> <span class="s">&#34;github.com/filecoin-project/specs-actors/actors/runtime/indices&#34;</span>
	<span class="nx">serde</span> <span class="s">&#34;github.com/filecoin-project/specs-actors/actors/serde&#34;</span>
	<span class="nx">filcrypto</span> <span class="s">&#34;github.com/filecoin-project/specs/algorithms/crypto&#34;</span>
	<span class="nx">filproofs</span> <span class="s">&#34;github.com/filecoin-project/specs/libraries/filcrypto/filproofs&#34;</span>
	<span class="nx">block</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_blockchain/struct/block&#34;</span>
	<span class="nx">msg</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_vm/message&#34;</span>
	<span class="nx">stateTree</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_vm/state_tree&#34;</span>
	<span class="nx">util</span> <span class="s">&#34;github.com/filecoin-project/specs/util&#34;</span>
	<span class="nx">cid</span> <span class="s">&#34;github.com/ipfs/go-cid&#34;</span>
	<span class="nx">peer</span> <span class="s">&#34;github.com/libp2p/go-libp2p-core/peer&#34;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">Serialization</span> <span class="p">=</span> <span class="nx">util</span><span class="p">.</span><span class="nx">Serialization</span>

<span class="kd">var</span> <span class="nx">Assert</span> <span class="p">=</span> <span class="nx">util</span><span class="p">.</span><span class="nx">Assert</span>
<span class="kd">var</span> <span class="nx">TODO</span> <span class="p">=</span> <span class="nx">util</span><span class="p">.</span><span class="nx">TODO</span>

<span class="c1">// Note that implementations may choose to provide default generation methods for miners created
</span><span class="c1">// without miner/owner keypairs. We omit these details from the spec.
</span><span class="c1">// Also note that the pledge amount should be available in the ownerAddr in order for this call
</span><span class="c1">// to succeed.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">sms</span> <span class="o">*</span><span class="nx">StorageMiningSubsystem_I</span><span class="p">)</span> <span class="nf">CreateMiner</span><span class="p">(</span>
	<span class="nx">state</span> <span class="nx">stateTree</span><span class="p">.</span><span class="nx">StateTree</span><span class="p">,</span>
	<span class="nx">ownerAddr</span> <span class="nx">addr</span><span class="p">.</span><span class="nx">Address</span><span class="p">,</span>
	<span class="nx">workerAddr</span> <span class="nx">addr</span><span class="p">.</span><span class="nx">Address</span><span class="p">,</span>
	<span class="nx">sectorSize</span> <span class="nx">util</span><span class="p">.</span><span class="nx">UInt</span><span class="p">,</span>
	<span class="nx">peerId</span> <span class="nx">peer</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span>
	<span class="nx">pledgeAmt</span> <span class="nx">abi</span><span class="p">.</span><span class="nx">TokenAmount</span><span class="p">,</span>
<span class="p">)</span> <span class="p">(</span><span class="nx">addr</span><span class="p">.</span><span class="nx">Address</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>

	<span class="nx">ownerActor</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">state</span><span class="p">.</span><span class="nf">GetActor</span><span class="p">(</span><span class="nx">ownerAddr</span><span class="p">)</span>
	<span class="nf">Assert</span><span class="p">(</span><span class="nx">ok</span><span class="p">)</span>

	<span class="nx">unsignedCreationMessage</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">msg</span><span class="p">.</span><span class="nx">UnsignedMessage_I</span><span class="p">{</span>
		<span class="nx">From_</span><span class="p">:</span>       <span class="nx">ownerAddr</span><span class="p">,</span>
		<span class="nx">To_</span><span class="p">:</span>         <span class="nx">builtin</span><span class="p">.</span><span class="nx">StoragePowerActorAddr</span><span class="p">,</span>
		<span class="nx">Method_</span><span class="p">:</span>     <span class="nx">builtin</span><span class="p">.</span><span class="nx">Method_StoragePowerActor_CreateMiner</span><span class="p">,</span>
		<span class="nx">Params_</span><span class="p">:</span>     <span class="nx">serde</span><span class="p">.</span><span class="nf">MustSerializeParams</span><span class="p">(</span><span class="nx">ownerAddr</span><span class="p">,</span> <span class="nx">workerAddr</span><span class="p">,</span> <span class="nx">peerId</span><span class="p">),</span>
		<span class="nx">CallSeqNum_</span><span class="p">:</span> <span class="nx">ownerActor</span><span class="p">.</span><span class="nf">CallSeqNum</span><span class="p">(),</span>
		<span class="nx">Value_</span><span class="p">:</span>      <span class="nx">pledgeAmt</span><span class="p">,</span>
		<span class="nx">GasPrice_</span><span class="p">:</span>   <span class="mi">0</span><span class="p">,</span>
		<span class="nx">GasLimit_</span><span class="p">:</span>   <span class="nx">msg</span><span class="p">.</span><span class="nf">GasAmount_SentinelUnlimited</span><span class="p">(),</span>
	<span class="p">}</span>

	<span class="kd">var</span> <span class="nx">workerKey</span> <span class="nx">filcrypto</span><span class="p">.</span><span class="nx">SigKeyPair</span> <span class="c1">// sms._keyStore().Worker()
</span><span class="c1"></span>	<span class="nx">signedMessage</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">Sign</span><span class="p">(</span><span class="nx">unsignedCreationMessage</span><span class="p">,</span> <span class="nx">workerKey</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">addr</span><span class="p">.</span><span class="nx">Undef</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>

	<span class="nx">err</span> <span class="p">=</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">Node</span><span class="p">().</span><span class="nf">MessagePool</span><span class="p">().</span><span class="nf">Syncer</span><span class="p">().</span><span class="nf">SubmitMessage</span><span class="p">(</span><span class="nx">signedMessage</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">addr</span><span class="p">.</span><span class="nx">Undef</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>

	<span class="c1">// WAIT for block reception with appropriate response from SPA
</span><span class="c1"></span>	<span class="nx">util</span><span class="p">.</span><span class="nf">IMPL_TODO</span><span class="p">()</span>

	<span class="c1">// harvest address from that block
</span><span class="c1"></span>	<span class="kd">var</span> <span class="nx">storageMinerAddr</span> <span class="nx">addr</span><span class="p">.</span><span class="nx">Address</span>
	<span class="c1">// and set in key store appropriately
</span><span class="c1"></span>	<span class="k">return</span> <span class="nx">storageMinerAddr</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">sms</span> <span class="o">*</span><span class="nx">StorageMiningSubsystem_I</span><span class="p">)</span> <span class="nf">HandleStorageDeal</span><span class="p">(</span><span class="nx">deal</span> <span class="nx">smarkact</span><span class="p">.</span><span class="nx">StorageDeal</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">sms</span><span class="p">.</span><span class="nf">SectorIndex</span><span class="p">().</span><span class="nf">AddNewDeal</span><span class="p">(</span><span class="nx">deal</span><span class="p">)</span>
	<span class="c1">// stagedDealResponse := sms.SectorIndex().AddNewDeal(deal)
</span><span class="c1"></span>	<span class="c1">// TODO: way within a node to notify different components
</span><span class="c1"></span>	<span class="c1">// market.StorageProvider().NotifyStorageDealStaged(&amp;storage_provider.StorageDealStagedNotification_I{
</span><span class="c1"></span>	<span class="c1">// 	Deal_:     deal,
</span><span class="c1"></span>	<span class="c1">// 	SectorID_: stagedDealResponse.SectorID(),
</span><span class="c1"></span>	<span class="c1">// })
</span><span class="c1"></span><span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">sms</span> <span class="o">*</span><span class="nx">StorageMiningSubsystem_I</span><span class="p">)</span> <span class="nf">CommitSectorError</span><span class="p">()</span> <span class="nx">smarkact</span><span class="p">.</span><span class="nx">StorageDeal</span> <span class="p">{</span>
	<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;TODO&#34;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// triggered by new block reception and tipset assembly
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">sms</span> <span class="o">*</span><span class="nx">StorageMiningSubsystem_I</span><span class="p">)</span> <span class="nf">OnNewBestChain</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">sms</span><span class="p">.</span><span class="nf">_runMiningCycle</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// triggered by wall clock
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">sms</span> <span class="o">*</span><span class="nx">StorageMiningSubsystem_I</span><span class="p">)</span> <span class="nf">OnNewRound</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">sms</span><span class="p">.</span><span class="nf">_runMiningCycle</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">sms</span> <span class="o">*</span><span class="nx">StorageMiningSubsystem_I</span><span class="p">)</span> <span class="nf">_runMiningCycle</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">chainHead</span> <span class="o">:=</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">_blockchain</span><span class="p">().</span><span class="nf">BestChain</span><span class="p">().</span><span class="nf">HeadTipset</span><span class="p">()</span>
	<span class="nx">sma</span> <span class="o">:=</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">_getStorageMinerActorState</span><span class="p">(</span><span class="nx">chainHead</span><span class="p">.</span><span class="nf">StateTree</span><span class="p">(),</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">Node</span><span class="p">().</span><span class="nf">Repository</span><span class="p">().</span><span class="nf">KeyStore</span><span class="p">().</span><span class="nf">MinerAddress</span><span class="p">())</span>

	<span class="k">if</span> <span class="nx">sma</span><span class="p">.</span><span class="nx">PoStState</span><span class="p">.</span><span class="nf">Is_OK</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">ePoSt</span> <span class="o">:=</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">_tryLeaderElection</span><span class="p">(</span><span class="nx">chainHead</span><span class="p">.</span><span class="nf">StateTree</span><span class="p">(),</span> <span class="nx">sma</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">ePoSt</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="c1">// Randomness for ticket generation in block production
</span><span class="c1"></span>			<span class="nx">randomness1</span> <span class="o">:=</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">_blockchain</span><span class="p">().</span><span class="nf">BestChain</span><span class="p">().</span><span class="nf">GetTicketProductionRandSeed</span><span class="p">(</span><span class="nx">sms</span><span class="p">.</span><span class="nf">_blockchain</span><span class="p">().</span><span class="nf">LatestEpoch</span><span class="p">())</span>
			<span class="nx">newTicket</span> <span class="o">:=</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">PrepareNewTicket</span><span class="p">(</span><span class="nx">randomness1</span><span class="p">,</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">Node</span><span class="p">().</span><span class="nf">Repository</span><span class="p">().</span><span class="nf">KeyStore</span><span class="p">().</span><span class="nf">MinerAddress</span><span class="p">())</span>

			<span class="nx">sms</span><span class="p">.</span><span class="nf">_blockProducer</span><span class="p">().</span><span class="nf">GenerateBlock</span><span class="p">(</span><span class="o">*</span><span class="nx">ePoSt</span><span class="p">,</span> <span class="nx">newTicket</span><span class="p">,</span> <span class="nx">chainHead</span><span class="p">,</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">Node</span><span class="p">().</span><span class="nf">Repository</span><span class="p">().</span><span class="nf">KeyStore</span><span class="p">().</span><span class="nf">MinerAddress</span><span class="p">())</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">sma</span><span class="p">.</span><span class="nx">PoStState</span><span class="p">.</span><span class="nf">Is_Challenged</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">sPoSt</span> <span class="o">:=</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">_trySurprisePoSt</span><span class="p">(</span><span class="nx">chainHead</span><span class="p">.</span><span class="nf">StateTree</span><span class="p">(),</span> <span class="nx">sma</span><span class="p">)</span>

		<span class="kd">var</span> <span class="nx">gasLimit</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">GasAmount</span>
		<span class="kd">var</span> <span class="nx">gasPrice</span> <span class="p">=</span> <span class="nx">abi</span><span class="p">.</span><span class="nf">TokenAmount</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
		<span class="nx">util</span><span class="p">.</span><span class="nf">IMPL_FINISH</span><span class="p">(</span><span class="s">&#34;read from consts (in this case user set param)&#34;</span><span class="p">)</span>
		<span class="nx">sms</span><span class="p">.</span><span class="nf">_submitSurprisePoStMessage</span><span class="p">(</span><span class="nx">chainHead</span><span class="p">.</span><span class="nf">StateTree</span><span class="p">(),</span> <span class="o">*</span><span class="nx">sPoSt</span><span class="p">,</span> <span class="nx">gasPrice</span><span class="p">,</span> <span class="nx">gasLimit</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">sms</span> <span class="o">*</span><span class="nx">StorageMiningSubsystem_I</span><span class="p">)</span> <span class="nf">_tryLeaderElection</span><span class="p">(</span><span class="nx">currState</span> <span class="nx">stateTree</span><span class="p">.</span><span class="nx">StateTree</span><span class="p">,</span> <span class="nx">sma</span> <span class="nx">sminact</span><span class="p">.</span><span class="nx">StorageMinerActorState</span><span class="p">)</span> <span class="o">*</span><span class="nx">abi</span><span class="p">.</span><span class="nx">OnChainElectionPoStVerifyInfo</span> <span class="p">{</span>
	<span class="c1">// Randomness for ElectionPoSt
</span><span class="c1"></span>
	<span class="nx">randomnessK</span> <span class="o">:=</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">_blockchain</span><span class="p">().</span><span class="nf">BestChain</span><span class="p">().</span><span class="nf">GetPoStChallengeRandSeed</span><span class="p">(</span><span class="nx">sms</span><span class="p">.</span><span class="nf">_blockchain</span><span class="p">().</span><span class="nf">LatestEpoch</span><span class="p">())</span>
	<span class="nx">input</span> <span class="o">:=</span> <span class="nx">acrypto</span><span class="p">.</span><span class="nf">DeriveRandWithMinerAddr</span><span class="p">(</span><span class="nx">acrypto</span><span class="p">.</span><span class="nx">DomainSeparationTag_ElectionPoStChallengeSeed</span><span class="p">,</span> <span class="nx">randomnessK</span><span class="p">,</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">Node</span><span class="p">().</span><span class="nf">Repository</span><span class="p">().</span><span class="nf">KeyStore</span><span class="p">().</span><span class="nf">MinerAddress</span><span class="p">())</span>
	<span class="c1">// Use VRF to generate secret randomness
</span><span class="c1"></span>	<span class="nx">postRandomness</span> <span class="o">:=</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">Node</span><span class="p">().</span><span class="nf">Repository</span><span class="p">().</span><span class="nf">KeyStore</span><span class="p">().</span><span class="nf">WorkerKey</span><span class="p">().</span><span class="nf">Impl</span><span class="p">().</span><span class="nf">Generate</span><span class="p">(</span><span class="nx">input</span><span class="p">).</span><span class="nf">Output</span><span class="p">()</span>

	<span class="c1">// TODO: add how sectors are actually stored in the SMS proving set
</span><span class="c1"></span>	<span class="nx">util</span><span class="p">.</span><span class="nf">TODO</span><span class="p">()</span>
	<span class="nx">provingSet</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">abi</span><span class="p">.</span><span class="nx">SectorID</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

	<span class="nx">candidates</span> <span class="o">:=</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">StorageProving</span><span class="p">().</span><span class="nf">Impl</span><span class="p">().</span><span class="nf">GenerateElectionPoStCandidates</span><span class="p">(</span><span class="nx">postRandomness</span><span class="p">,</span> <span class="nx">provingSet</span><span class="p">)</span>

	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">candidates</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span> <span class="c1">// fail to generate post candidates
</span><span class="c1"></span>	<span class="p">}</span>

	<span class="nx">winningCandidates</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">abi</span><span class="p">.</span><span class="nx">PoStCandidate</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

	<span class="kd">var</span> <span class="nx">numMinerSectors</span> <span class="kt">uint64</span>
	<span class="nf">TODO</span><span class="p">()</span> <span class="c1">// update
</span><span class="c1"></span>	<span class="c1">// numMinerSectors := uint64(len(sma.SectorTable().Impl().ActiveSectors_.SectorsOn()))
</span><span class="c1"></span>
	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">candidate</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">candidates</span> <span class="p">{</span>
		<span class="nx">sectorNum</span> <span class="o">:=</span> <span class="nx">candidate</span><span class="p">.</span><span class="nx">SectorID</span><span class="p">.</span><span class="nx">Number</span>
		<span class="nx">sectorWeightDesc</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">sma</span><span class="p">.</span><span class="nf">GetStorageWeightDescForSectorMaybe</span><span class="p">(</span><span class="nx">sectorNum</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
			<span class="k">return</span> <span class="kc">nil</span>
		<span class="p">}</span>
		<span class="nx">sectorPower</span> <span class="o">:=</span> <span class="nx">indices</span><span class="p">.</span><span class="nf">ConsensusPowerForStorageWeight</span><span class="p">(</span><span class="nx">sectorWeightDesc</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">_consensus</span><span class="p">().</span><span class="nf">IsWinningPartialTicket</span><span class="p">(</span><span class="nx">currState</span><span class="p">,</span> <span class="nx">candidate</span><span class="p">.</span><span class="nx">PartialTicket</span><span class="p">,</span> <span class="nx">sectorPower</span><span class="p">,</span> <span class="nx">numMinerSectors</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">winningCandidates</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">winningCandidates</span><span class="p">,</span> <span class="nx">candidate</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">winningCandidates</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span>
	<span class="p">}</span>

	<span class="nx">postProofs</span> <span class="o">:=</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">StorageProving</span><span class="p">().</span><span class="nf">Impl</span><span class="p">().</span><span class="nf">CreateElectionPoStProof</span><span class="p">(</span><span class="nx">postRandomness</span><span class="p">,</span> <span class="nx">winningCandidates</span><span class="p">)</span>

	<span class="nx">electionPoSt</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">abi</span><span class="p">.</span><span class="nx">OnChainElectionPoStVerifyInfo</span><span class="p">{</span>
		<span class="nx">Candidates</span><span class="p">:</span> <span class="nx">winningCandidates</span><span class="p">,</span>
		<span class="nx">Randomness</span><span class="p">:</span> <span class="nx">postRandomness</span><span class="p">,</span>
		<span class="nx">Proofs</span><span class="p">:</span>     <span class="nx">postProofs</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nx">electionPoSt</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">sms</span> <span class="o">*</span><span class="nx">StorageMiningSubsystem_I</span><span class="p">)</span> <span class="nf">PrepareNewTicket</span><span class="p">(</span><span class="nx">randomness</span> <span class="nx">abi</span><span class="p">.</span><span class="nx">RandomnessSeed</span><span class="p">,</span> <span class="nx">minerActorAddr</span> <span class="nx">addr</span><span class="p">.</span><span class="nx">Address</span><span class="p">)</span> <span class="nx">block</span><span class="p">.</span><span class="nx">Ticket</span> <span class="p">{</span>
	<span class="c1">// run it through the VRF and get deterministic output
</span><span class="c1"></span>
	<span class="c1">// take the VRFResult of that ticket as input, specifying the personalization (see data structures)
</span><span class="c1"></span>	<span class="c1">// append the miner actor address for the miner generifying this in order to prevent miners with the same
</span><span class="c1"></span>	<span class="c1">// worker keys from generating the same randomness (given the VRF)
</span><span class="c1"></span>	<span class="nx">input</span> <span class="o">:=</span> <span class="nx">acrypto</span><span class="p">.</span><span class="nf">DeriveRandWithMinerAddr</span><span class="p">(</span><span class="nx">acrypto</span><span class="p">.</span><span class="nx">DomainSeparationTag_TicketProduction</span><span class="p">,</span> <span class="nx">randomness</span><span class="p">,</span> <span class="nx">minerActorAddr</span><span class="p">)</span>

	<span class="c1">// run through VRF
</span><span class="c1"></span>	<span class="nx">vrfRes</span> <span class="o">:=</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">Node</span><span class="p">().</span><span class="nf">Repository</span><span class="p">().</span><span class="nf">KeyStore</span><span class="p">().</span><span class="nf">WorkerKey</span><span class="p">().</span><span class="nf">Impl</span><span class="p">().</span><span class="nf">Generate</span><span class="p">(</span><span class="nx">input</span><span class="p">)</span>

	<span class="nx">newTicket</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">block</span><span class="p">.</span><span class="nx">Ticket_I</span><span class="p">{</span>
		<span class="nx">VRFResult_</span><span class="p">:</span> <span class="nx">vrfRes</span><span class="p">,</span>
		<span class="nx">Output_</span><span class="p">:</span>    <span class="nx">vrfRes</span><span class="p">.</span><span class="nf">Output</span><span class="p">(),</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nx">newTicket</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">sms</span> <span class="o">*</span><span class="nx">StorageMiningSubsystem_I</span><span class="p">)</span> <span class="nf">_getStorageMinerActorState</span><span class="p">(</span><span class="nx">stateTree</span> <span class="nx">stateTree</span><span class="p">.</span><span class="nx">StateTree</span><span class="p">,</span> <span class="nx">minerAddr</span> <span class="nx">addr</span><span class="p">.</span><span class="nx">Address</span><span class="p">)</span> <span class="nx">sminact</span><span class="p">.</span><span class="nx">StorageMinerActorState</span> <span class="p">{</span>
	<span class="nx">actorState</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">stateTree</span><span class="p">.</span><span class="nf">GetActor</span><span class="p">(</span><span class="nx">minerAddr</span><span class="p">)</span>
	<span class="nx">util</span><span class="p">.</span><span class="nf">Assert</span><span class="p">(</span><span class="nx">ok</span><span class="p">)</span>
	<span class="nx">substateCID</span> <span class="o">:=</span> <span class="nx">actorState</span><span class="p">.</span><span class="nf">State</span><span class="p">()</span>

	<span class="nx">substate</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">Node</span><span class="p">().</span><span class="nf">Repository</span><span class="p">().</span><span class="nf">StateStore</span><span class="p">().</span><span class="nf">Get</span><span class="p">(</span><span class="nx">cid</span><span class="p">.</span><span class="nf">Cid</span><span class="p">(</span><span class="nx">substateCID</span><span class="p">))</span>
	<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;Couldn&#39;t find sma state&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="c1">// fix conversion to bytes
</span><span class="c1"></span>	<span class="nx">util</span><span class="p">.</span><span class="nf">IMPL_TODO</span><span class="p">(</span><span class="nx">substate</span><span class="p">)</span>
	<span class="kd">var</span> <span class="nx">serializedSubstate</span> <span class="nx">Serialization</span>
	<span class="kd">var</span> <span class="nx">st</span> <span class="nx">sminact</span><span class="p">.</span><span class="nx">StorageMinerActorState</span>
	<span class="nx">serde</span><span class="p">.</span><span class="nf">MustDeserialize</span><span class="p">(</span><span class="nx">serializedSubstate</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">st</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">st</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">sms</span> <span class="o">*</span><span class="nx">StorageMiningSubsystem_I</span><span class="p">)</span> <span class="nf">_getStoragePowerActorState</span><span class="p">(</span><span class="nx">stateTree</span> <span class="nx">stateTree</span><span class="p">.</span><span class="nx">StateTree</span><span class="p">)</span> <span class="nx">spowact</span><span class="p">.</span><span class="nx">StoragePowerActorState</span> <span class="p">{</span>
	<span class="nx">powerAddr</span> <span class="o">:=</span> <span class="nx">builtin</span><span class="p">.</span><span class="nx">StoragePowerActorAddr</span>
	<span class="nx">actorState</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">stateTree</span><span class="p">.</span><span class="nf">GetActor</span><span class="p">(</span><span class="nx">powerAddr</span><span class="p">)</span>
	<span class="nx">util</span><span class="p">.</span><span class="nf">Assert</span><span class="p">(</span><span class="nx">ok</span><span class="p">)</span>
	<span class="nx">substateCID</span> <span class="o">:=</span> <span class="nx">actorState</span><span class="p">.</span><span class="nf">State</span><span class="p">()</span>

	<span class="nx">substate</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">Node</span><span class="p">().</span><span class="nf">Repository</span><span class="p">().</span><span class="nf">StateStore</span><span class="p">().</span><span class="nf">Get</span><span class="p">(</span><span class="nx">cid</span><span class="p">.</span><span class="nf">Cid</span><span class="p">(</span><span class="nx">substateCID</span><span class="p">))</span>
	<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;Couldn&#39;t find spa state&#34;</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c1">// fix conversion to bytes
</span><span class="c1"></span>	<span class="nx">util</span><span class="p">.</span><span class="nf">IMPL_TODO</span><span class="p">(</span><span class="nx">substate</span><span class="p">)</span>
	<span class="kd">var</span> <span class="nx">serializedSubstate</span> <span class="nx">util</span><span class="p">.</span><span class="nx">Serialization</span>
	<span class="kd">var</span> <span class="nx">st</span> <span class="nx">spowact</span><span class="p">.</span><span class="nx">StoragePowerActorState</span>
	<span class="nx">serde</span><span class="p">.</span><span class="nf">MustDeserialize</span><span class="p">(</span><span class="nx">serializedSubstate</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">st</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">st</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">sms</span> <span class="o">*</span><span class="nx">StorageMiningSubsystem_I</span><span class="p">)</span> <span class="nf">VerifyElectionPoSt</span><span class="p">(</span><span class="nx">inds</span> <span class="nx">indices</span><span class="p">.</span><span class="nx">Indices</span><span class="p">,</span> <span class="nx">header</span> <span class="nx">block</span><span class="p">.</span><span class="nx">BlockHeader</span><span class="p">,</span> <span class="nx">onChainInfo</span> <span class="nx">abi</span><span class="p">.</span><span class="nx">OnChainElectionPoStVerifyInfo</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="nx">sma</span> <span class="o">:=</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">_getStorageMinerActorState</span><span class="p">(</span><span class="nx">header</span><span class="p">.</span><span class="nf">ParentState</span><span class="p">(),</span> <span class="nx">header</span><span class="p">.</span><span class="nf">Miner</span><span class="p">())</span>
	<span class="nx">spa</span> <span class="o">:=</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">_getStoragePowerActorState</span><span class="p">(</span><span class="nx">header</span><span class="p">.</span><span class="nf">ParentState</span><span class="p">())</span>

	<span class="nx">pow</span><span class="p">,</span> <span class="nx">found</span> <span class="o">:=</span> <span class="nx">spa</span><span class="p">.</span><span class="nx">PowerTable</span><span class="p">[</span><span class="nx">header</span><span class="p">.</span><span class="nf">Miner</span><span class="p">()]</span>
	<span class="k">if</span> <span class="p">!</span><span class="nx">found</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">false</span>
	<span class="p">}</span>

	<span class="c1">// 1. Verify miner has enough power (includes implicit checks on min miner size
</span><span class="c1"></span>	<span class="c1">// and challenge status via SPA&#39;s power table).
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">pow</span> <span class="o">==</span> <span class="nx">abi</span><span class="p">.</span><span class="nf">StoragePower</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">false</span>
	<span class="p">}</span>

	<span class="c1">// 2. verify no duplicate tickets included
</span><span class="c1"></span>	<span class="nx">challengeIndices</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">int64</span><span class="p">]</span><span class="kt">bool</span><span class="p">)</span>
	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">tix</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">onChainInfo</span><span class="p">.</span><span class="nx">Candidates</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">challengeIndices</span><span class="p">[</span><span class="nx">tix</span><span class="p">.</span><span class="nx">ChallengeIndex</span><span class="p">];</span> <span class="nx">ok</span> <span class="p">{</span>
			<span class="k">return</span> <span class="kc">false</span>
		<span class="p">}</span>
		<span class="nx">challengeIndices</span><span class="p">[</span><span class="nx">tix</span><span class="p">.</span><span class="nx">ChallengeIndex</span><span class="p">]</span> <span class="p">=</span> <span class="kc">true</span>
	<span class="p">}</span>

	<span class="c1">// 3. Verify partialTicket values are appropriate
</span><span class="c1"></span>	<span class="k">if</span> <span class="p">!</span><span class="nx">sms</span><span class="p">.</span><span class="nf">_verifyElection</span><span class="p">(</span><span class="nx">header</span><span class="p">,</span> <span class="nx">onChainInfo</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">false</span>
	<span class="p">}</span>

	<span class="c1">// verify the partialTickets themselves
</span><span class="c1"></span>	<span class="c1">// 4. Verify appropriate randomness
</span><span class="c1"></span>	<span class="c1">// TODO: fix away from BestChain()... every block should track its own chain up to its own production.
</span><span class="c1"></span>	<span class="nx">randomness</span> <span class="o">:=</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">_blockchain</span><span class="p">().</span><span class="nf">BestChain</span><span class="p">().</span><span class="nf">GetPoStChallengeRandSeed</span><span class="p">(</span><span class="nx">header</span><span class="p">.</span><span class="nf">Epoch</span><span class="p">())</span>
	<span class="nx">input</span> <span class="o">:=</span> <span class="nx">acrypto</span><span class="p">.</span><span class="nf">DeriveRandWithMinerAddr</span><span class="p">(</span><span class="nx">acrypto</span><span class="p">.</span><span class="nx">DomainSeparationTag_ElectionPoStChallengeSeed</span><span class="p">,</span> <span class="nx">randomness</span><span class="p">,</span> <span class="nx">header</span><span class="p">.</span><span class="nf">Miner</span><span class="p">())</span>

	<span class="nx">postRand</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">filcrypto</span><span class="p">.</span><span class="nx">VRFResult_I</span><span class="p">{</span>
		<span class="nx">Output_</span><span class="p">:</span> <span class="nx">onChainInfo</span><span class="p">.</span><span class="nx">Randomness</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="c1">// TODO if the workerAddress is secp then payload will be the blake2b hash of its public key
</span><span class="c1"></span>	<span class="c1">// and we will need to recover the entire public key from worker before handing off to Verify
</span><span class="c1"></span>	<span class="c1">// example of recover code: https://github.com/ipsn/go-secp256k1/blob/master/secp256.go#L93
</span><span class="c1"></span>	<span class="nx">workerKey</span> <span class="o">:=</span> <span class="nx">sma</span><span class="p">.</span><span class="nx">Info</span><span class="p">.</span><span class="nx">Worker</span><span class="p">.</span><span class="nf">Payload</span><span class="p">()</span>
	<span class="c1">// Verify VRF output from appropriate input corresponds to randomness used
</span><span class="c1"></span>	<span class="k">if</span> <span class="p">!</span><span class="nx">postRand</span><span class="p">.</span><span class="nf">Verify</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">filcrypto</span><span class="p">.</span><span class="nf">VRFPublicKey</span><span class="p">(</span><span class="nx">workerKey</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">false</span>
	<span class="p">}</span>

	<span class="c1">// A proof must be a valid snark proof with the correct public inputs
</span><span class="c1"></span>	<span class="c1">// 5. Get public inputs
</span><span class="c1"></span>	<span class="nx">info</span> <span class="o">:=</span> <span class="nx">sma</span><span class="p">.</span><span class="nx">Info</span>
	<span class="nx">sectorSize</span> <span class="o">:=</span> <span class="nx">info</span><span class="p">.</span><span class="nx">SectorSize</span>

	<span class="nx">postCfg</span> <span class="o">:=</span> <span class="nx">filproofs</span><span class="p">.</span><span class="nf">ElectionPoStCfg</span><span class="p">(</span><span class="nx">sectorSize</span><span class="p">)</span>

	<span class="nx">pvInfo</span> <span class="o">:=</span> <span class="nx">abi</span><span class="p">.</span><span class="nx">PoStVerifyInfo</span><span class="p">{</span>
		<span class="nx">Candidates</span><span class="p">:</span> <span class="nx">onChainInfo</span><span class="p">.</span><span class="nx">Candidates</span><span class="p">,</span>
		<span class="nx">Proofs</span><span class="p">:</span>     <span class="nx">onChainInfo</span><span class="p">.</span><span class="nx">Proofs</span><span class="p">,</span>
		<span class="nx">Randomness</span><span class="p">:</span> <span class="nx">onChainInfo</span><span class="p">.</span><span class="nx">Randomness</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="nx">pv</span> <span class="o">:=</span> <span class="nx">filproofs</span><span class="p">.</span><span class="nf">MakeElectionPoStVerifier</span><span class="p">(</span><span class="nx">postCfg</span><span class="p">)</span>

	<span class="c1">// 5. Verify the PoSt Proof
</span><span class="c1"></span>	<span class="nx">isPoStVerified</span> <span class="o">:=</span> <span class="nx">pv</span><span class="p">.</span><span class="nf">VerifyElectionPoSt</span><span class="p">(</span><span class="nx">pvInfo</span><span class="p">)</span>

	<span class="k">return</span> <span class="nx">isPoStVerified</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">sms</span> <span class="o">*</span><span class="nx">StorageMiningSubsystem_I</span><span class="p">)</span> <span class="nf">_verifyElection</span><span class="p">(</span><span class="nx">header</span> <span class="nx">block</span><span class="p">.</span><span class="nx">BlockHeader</span><span class="p">,</span> <span class="nx">onChainInfo</span> <span class="nx">abi</span><span class="p">.</span><span class="nx">OnChainElectionPoStVerifyInfo</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="nx">st</span> <span class="o">:=</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">_getStorageMinerActorState</span><span class="p">(</span><span class="nx">header</span><span class="p">.</span><span class="nf">ParentState</span><span class="p">(),</span> <span class="nx">header</span><span class="p">.</span><span class="nf">Miner</span><span class="p">())</span>

	<span class="kd">var</span> <span class="nx">numMinerSectors</span> <span class="kt">uint64</span>
	<span class="nf">TODO</span><span class="p">()</span>
	<span class="c1">// TODO: Decide whether to sample sectors uniformly for EPoSt (the cleanest),
</span><span class="c1"></span>	<span class="c1">// or to sample weighted by nominal power.
</span><span class="c1"></span>
	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">info</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">onChainInfo</span><span class="p">.</span><span class="nx">Candidates</span> <span class="p">{</span>
		<span class="nx">sectorNum</span> <span class="o">:=</span> <span class="nx">info</span><span class="p">.</span><span class="nx">SectorID</span><span class="p">.</span><span class="nx">Number</span>
		<span class="nx">sectorWeightDesc</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">GetStorageWeightDescForSectorMaybe</span><span class="p">(</span><span class="nx">sectorNum</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
			<span class="k">return</span> <span class="kc">false</span>
		<span class="p">}</span>
		<span class="nx">sectorPower</span> <span class="o">:=</span> <span class="nx">indices</span><span class="p">.</span><span class="nf">ConsensusPowerForStorageWeight</span><span class="p">(</span><span class="nx">sectorWeightDesc</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">!</span><span class="nx">sms</span><span class="p">.</span><span class="nf">_consensus</span><span class="p">().</span><span class="nf">IsWinningPartialTicket</span><span class="p">(</span><span class="nx">header</span><span class="p">.</span><span class="nf">ParentState</span><span class="p">(),</span> <span class="nx">info</span><span class="p">.</span><span class="nx">PartialTicket</span><span class="p">,</span> <span class="nx">sectorPower</span><span class="p">,</span> <span class="nx">numMinerSectors</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="kc">false</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="kc">true</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">sms</span> <span class="o">*</span><span class="nx">StorageMiningSubsystem_I</span><span class="p">)</span> <span class="nf">_trySurprisePoSt</span><span class="p">(</span><span class="nx">currState</span> <span class="nx">stateTree</span><span class="p">.</span><span class="nx">StateTree</span><span class="p">,</span> <span class="nx">sma</span> <span class="nx">sminact</span><span class="p">.</span><span class="nx">StorageMinerActorState</span><span class="p">)</span> <span class="o">*</span><span class="nx">abi</span><span class="p">.</span><span class="nx">OnChainSurprisePoStVerifyInfo</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">!</span><span class="nx">sma</span><span class="p">.</span><span class="nx">PoStState</span><span class="p">.</span><span class="nf">Is_Challenged</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span>
	<span class="p">}</span>

	<span class="c1">// get randomness for SurprisePoSt
</span><span class="c1"></span>	<span class="nx">challEpoch</span> <span class="o">:=</span> <span class="nx">sma</span><span class="p">.</span><span class="nx">PoStState</span><span class="p">.</span><span class="nx">SurpriseChallengeEpoch</span>
	<span class="nx">randomnessK</span> <span class="o">:=</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">_blockchain</span><span class="p">().</span><span class="nf">BestChain</span><span class="p">().</span><span class="nf">GetPoStChallengeRandSeed</span><span class="p">(</span><span class="nx">challEpoch</span><span class="p">)</span>
	<span class="c1">// unlike with ElectionPoSt no need to use a VRF
</span><span class="c1"></span>	<span class="nx">postRandomness</span> <span class="o">:=</span> <span class="nx">acrypto</span><span class="p">.</span><span class="nf">DeriveRandWithMinerAddr</span><span class="p">(</span><span class="nx">acrypto</span><span class="p">.</span><span class="nx">DomainSeparationTag_SurprisePoStChallengeSeed</span><span class="p">,</span> <span class="nx">randomnessK</span><span class="p">,</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">Node</span><span class="p">().</span><span class="nf">Repository</span><span class="p">().</span><span class="nf">KeyStore</span><span class="p">().</span><span class="nf">MinerAddress</span><span class="p">())</span>

	<span class="c1">// TODO: add how sectors are actually stored in the SMS proving set
</span><span class="c1"></span>	<span class="nx">util</span><span class="p">.</span><span class="nf">TODO</span><span class="p">()</span>
	<span class="nx">provingSet</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">abi</span><span class="p">.</span><span class="nx">SectorID</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

	<span class="nx">candidates</span> <span class="o">:=</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">StorageProving</span><span class="p">().</span><span class="nf">Impl</span><span class="p">().</span><span class="nf">GenerateSurprisePoStCandidates</span><span class="p">(</span><span class="nx">abi</span><span class="p">.</span><span class="nf">PoStRandomness</span><span class="p">(</span><span class="nx">postRandomness</span><span class="p">),</span> <span class="nx">provingSet</span><span class="p">)</span>

	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">candidates</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="c1">// Error. Will fail this surprise post and must then redeclare faults
</span><span class="c1"></span>		<span class="k">return</span> <span class="kc">nil</span> <span class="c1">// fail to generate post candidates
</span><span class="c1"></span>	<span class="p">}</span>

	<span class="nx">winningCandidates</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">abi</span><span class="p">.</span><span class="nx">PoStCandidate</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">candidate</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">candidates</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">sma</span><span class="p">.</span><span class="nf">VerifySurprisePoStMeetsTargetReq</span><span class="p">(</span><span class="nx">candidate</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">winningCandidates</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">winningCandidates</span><span class="p">,</span> <span class="nx">candidate</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="nx">postProofs</span> <span class="o">:=</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">StorageProving</span><span class="p">().</span><span class="nf">Impl</span><span class="p">().</span><span class="nf">CreateSurprisePoStProof</span><span class="p">(</span><span class="nx">abi</span><span class="p">.</span><span class="nf">PoStRandomness</span><span class="p">(</span><span class="nx">postRandomness</span><span class="p">),</span> <span class="nx">winningCandidates</span><span class="p">)</span>

	<span class="c1">// var ctc sector.ChallengeTicketsCommitment // TODO: proofs to fix when complete
</span><span class="c1"></span>	<span class="nx">surprisePoSt</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">abi</span><span class="p">.</span><span class="nx">OnChainSurprisePoStVerifyInfo</span><span class="p">{</span>
		<span class="c1">// CommT_:      ctc,
</span><span class="c1"></span>		<span class="nx">Candidates</span><span class="p">:</span> <span class="nx">winningCandidates</span><span class="p">,</span>
		<span class="nx">Proofs</span><span class="p">:</span>     <span class="nx">postProofs</span><span class="p">,</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">surprisePoSt</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">sms</span> <span class="o">*</span><span class="nx">StorageMiningSubsystem_I</span><span class="p">)</span> <span class="nf">_submitSurprisePoStMessage</span><span class="p">(</span><span class="nx">state</span> <span class="nx">stateTree</span><span class="p">.</span><span class="nx">StateTree</span><span class="p">,</span> <span class="nx">sPoSt</span> <span class="nx">abi</span><span class="p">.</span><span class="nx">OnChainSurprisePoStVerifyInfo</span><span class="p">,</span> <span class="nx">gasPrice</span> <span class="nx">abi</span><span class="p">.</span><span class="nx">TokenAmount</span><span class="p">,</span> <span class="nx">gasLimit</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">GasAmount</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="c1">// TODO if workerAddr is not a secp key (e.g. BLS) then this will need to be handled differently
</span><span class="c1"></span>	<span class="nx">workerAddr</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">addr</span><span class="p">.</span><span class="nf">NewSecp256k1Address</span><span class="p">(</span><span class="nx">sms</span><span class="p">.</span><span class="nf">Node</span><span class="p">().</span><span class="nf">Repository</span><span class="p">().</span><span class="nf">KeyStore</span><span class="p">().</span><span class="nf">WorkerKey</span><span class="p">().</span><span class="nf">VRFPublicKey</span><span class="p">())</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="nx">worker</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">state</span><span class="p">.</span><span class="nf">GetActor</span><span class="p">(</span><span class="nx">workerAddr</span><span class="p">)</span>
	<span class="nf">Assert</span><span class="p">(</span><span class="nx">ok</span><span class="p">)</span>
	<span class="nx">unsignedCreationMessage</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">msg</span><span class="p">.</span><span class="nx">UnsignedMessage_I</span><span class="p">{</span>
		<span class="nx">From_</span><span class="p">:</span>       <span class="nx">sms</span><span class="p">.</span><span class="nf">Node</span><span class="p">().</span><span class="nf">Repository</span><span class="p">().</span><span class="nf">KeyStore</span><span class="p">().</span><span class="nf">MinerAddress</span><span class="p">(),</span>
		<span class="nx">To_</span><span class="p">:</span>         <span class="nx">sms</span><span class="p">.</span><span class="nf">Node</span><span class="p">().</span><span class="nf">Repository</span><span class="p">().</span><span class="nf">KeyStore</span><span class="p">().</span><span class="nf">MinerAddress</span><span class="p">(),</span>
		<span class="nx">Method_</span><span class="p">:</span>     <span class="nx">builtin</span><span class="p">.</span><span class="nx">Method_StorageMinerActor_SubmitSurprisePoStResponse</span><span class="p">,</span>
		<span class="nx">Params_</span><span class="p">:</span>     <span class="nx">serde</span><span class="p">.</span><span class="nf">MustSerializeParams</span><span class="p">(</span><span class="nx">sPoSt</span><span class="p">),</span>
		<span class="nx">CallSeqNum_</span><span class="p">:</span> <span class="nx">worker</span><span class="p">.</span><span class="nf">CallSeqNum</span><span class="p">(),</span>
		<span class="nx">Value_</span><span class="p">:</span>      <span class="nx">abi</span><span class="p">.</span><span class="nf">TokenAmount</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
		<span class="nx">GasPrice_</span><span class="p">:</span>   <span class="nx">gasPrice</span><span class="p">,</span>
		<span class="nx">GasLimit_</span><span class="p">:</span>   <span class="nx">gasLimit</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="kd">var</span> <span class="nx">workerKey</span> <span class="nx">filcrypto</span><span class="p">.</span><span class="nx">SigKeyPair</span> <span class="c1">// sms.Node().Repository().KeyStore().Worker()
</span><span class="c1"></span>	<span class="nx">signedMessage</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">Sign</span><span class="p">(</span><span class="nx">unsignedCreationMessage</span><span class="p">,</span> <span class="nx">workerKey</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>

	<span class="nx">err</span> <span class="p">=</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">Node</span><span class="p">().</span><span class="nf">MessagePool</span><span class="p">().</span><span class="nf">Syncer</span><span class="p">().</span><span class="nf">SubmitMessage</span><span class="p">(</span><span class="nx">signedMessage</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div>





<h3 id="ticket-validation">Ticket Validation</h3>
<p>Each Ticket should be generated from the prior one in the ticket-chain and verified accordingly as shown in <code>validateTicket</code> below.</p>
<p>


















<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="nx">abi</span> <span class="s">&#34;github.com/filecoin-project/specs-actors/actors/abi&#34;</span>
<span class="kn">import</span> <span class="nx">addr</span> <span class="s">&#34;github.com/filecoin-project/go-address&#34;</span>
<span class="kn">import</span> <span class="nx">block</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_blockchain/struct/block&#34;</span>
<span class="kn">import</span> <span class="nx">chain</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_blockchain/struct/chain&#34;</span>
<span class="kn">import</span> <span class="nx">st</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_vm/state_tree&#34;</span>
<span class="kn">import</span> <span class="nx">filcrypto</span> <span class="s">&#34;github.com/filecoin-project/specs/algorithms/crypto&#34;</span>
<span class="kn">import</span> <span class="nx">blockchain</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_blockchain&#34;</span>
<span class="kn">import</span> <span class="nx">spowact</span> <span class="s">&#34;github.com/filecoin-project/specs-actors/actors/builtin/storage_power&#34;</span>
<span class="kn">import</span> <span class="nx">node_base</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_nodes/node_base&#34;</span>

<span class="kd">type</span> <span class="nx">StoragePowerConsensusSubsystem</span> <span class="kd">struct</span> <span class="p">{</span><span class="c1">//(@mutable)
</span><span class="c1"></span>    <span class="nf">ChooseTipsetToMine</span><span class="p">(</span><span class="nx">tipsets</span> <span class="p">[</span><span class="nx">chain</span><span class="p">.</span><span class="nx">Tipset</span><span class="p">])</span> <span class="p">[</span><span class="nx">chain</span><span class="p">.</span><span class="nx">Tipset</span><span class="p">]</span>

    <span class="nx">node</span>        <span class="nx">node_base</span><span class="p">.</span><span class="nx">FilecoinNode</span>
    <span class="nx">ec</span>          <span class="nx">ExpectedConsensus</span>
    <span class="nx">blockchain</span>  <span class="nx">blockchain</span><span class="p">.</span><span class="nx">BlockchainSubsystem</span>

    <span class="c1">// call by BlockchainSubsystem during block reception
</span><span class="c1"></span>    <span class="nf">ValidateBlock</span><span class="p">(</span><span class="nx">block</span> <span class="nx">block</span><span class="p">.</span><span class="nx">Block</span><span class="p">)</span> <span class="kt">error</span>

    <span class="nf">IsWinningPartialTicket</span><span class="p">(</span>
        <span class="nx">st</span>                 <span class="nx">st</span><span class="p">.</span><span class="nx">StateTree</span>
        <span class="nx">partialTicket</span>      <span class="nx">abi</span><span class="p">.</span><span class="nx">PartialTicket</span>
        <span class="nx">sectorUtilization</span>  <span class="nx">abi</span><span class="p">.</span><span class="nx">StoragePower</span>
        <span class="nx">numSectors</span>         <span class="nx">util</span><span class="p">.</span><span class="nx">UVarint</span>
    <span class="p">)</span> <span class="kt">bool</span>

    <span class="nf">_getStoragePowerActorState</span><span class="p">(</span><span class="nx">stateTree</span> <span class="nx">st</span><span class="p">.</span><span class="nx">StateTree</span><span class="p">)</span> <span class="nx">spowact</span><span class="p">.</span><span class="nx">StoragePowerActorState</span>

    <span class="nf">validateTicket</span><span class="p">(</span>
        <span class="nx">tix</span>             <span class="nx">block</span><span class="p">.</span><span class="nx">Ticket</span>
        <span class="nx">pk</span>              <span class="nx">filcrypto</span><span class="p">.</span><span class="nx">VRFPublicKey</span>
        <span class="nx">minerActorAddr</span>  <span class="nx">addr</span><span class="p">.</span><span class="nx">Address</span>
    <span class="p">)</span> <span class="kt">bool</span>

    <span class="nf">computeChainWeight</span><span class="p">(</span><span class="nx">tipset</span> <span class="nx">chain</span><span class="p">.</span><span class="nx">Tipset</span><span class="p">)</span> <span class="nx">block</span><span class="p">.</span><span class="nx">ChainWeight</span>

    <span class="nf">StoragePowerConsensusError</span><span class="p">()</span> <span class="nx">StoragePowerConsensusError</span>

    <span class="nf">GetFinalizedEpoch</span><span class="p">(</span><span class="nx">currentEpoch</span> <span class="nx">abi</span><span class="p">.</span><span class="nx">ChainEpoch</span><span class="p">)</span> <span class="nx">abi</span><span class="p">.</span><span class="nx">ChainEpoch</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">StoragePowerConsensusError</span> <span class="kd">struct</span> <span class="p">{}</span>
</code></pre></div>
























<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">storage_power_consensus</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;math&#34;</span>

	<span class="nx">addr</span> <span class="s">&#34;github.com/filecoin-project/go-address&#34;</span>
	<span class="nx">abi</span> <span class="s">&#34;github.com/filecoin-project/specs-actors/actors/abi&#34;</span>
	<span class="nx">builtin</span> <span class="s">&#34;github.com/filecoin-project/specs-actors/actors/builtin&#34;</span>
	<span class="nx">spowact</span> <span class="s">&#34;github.com/filecoin-project/specs-actors/actors/builtin/storage_power&#34;</span>
	<span class="nx">acrypto</span> <span class="s">&#34;github.com/filecoin-project/specs-actors/actors/crypto&#34;</span>
	<span class="nx">inds</span> <span class="s">&#34;github.com/filecoin-project/specs-actors/actors/runtime/indices&#34;</span>
	<span class="nx">serde</span> <span class="s">&#34;github.com/filecoin-project/specs-actors/actors/serde&#34;</span>
	<span class="nx">filcrypto</span> <span class="s">&#34;github.com/filecoin-project/specs/algorithms/crypto&#34;</span>
	<span class="nx">block</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_blockchain/struct/block&#34;</span>
	<span class="nx">chain</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_blockchain/struct/chain&#34;</span>
	<span class="nx">node_base</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_nodes/node_base&#34;</span>
	<span class="nx">stateTree</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_vm/state_tree&#34;</span>
	<span class="nx">util</span> <span class="s">&#34;github.com/filecoin-project/specs/util&#34;</span>
	<span class="nx">cid</span> <span class="s">&#34;github.com/ipfs/go-cid&#34;</span>
<span class="p">)</span>

<span class="c1">// Storage Power Consensus Subsystem
</span><span class="c1"></span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">spc</span> <span class="o">*</span><span class="nx">StoragePowerConsensusSubsystem_I</span><span class="p">)</span> <span class="nf">ValidateBlock</span><span class="p">(</span><span class="nx">block</span> <span class="nx">block</span><span class="p">.</span><span class="nx">Block_I</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">util</span><span class="p">.</span><span class="nf">IMPL_FINISH</span><span class="p">()</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">spc</span> <span class="o">*</span><span class="nx">StoragePowerConsensusSubsystem_I</span><span class="p">)</span> <span class="nf">validateTicket</span><span class="p">(</span><span class="nx">ticket</span> <span class="nx">block</span><span class="p">.</span><span class="nx">Ticket</span><span class="p">,</span> <span class="nx">pk</span> <span class="nx">filcrypto</span><span class="p">.</span><span class="nx">VRFPublicKey</span><span class="p">,</span> <span class="nx">minerActorAddr</span> <span class="nx">addr</span><span class="p">.</span><span class="nx">Address</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="nx">randomness1</span> <span class="o">:=</span> <span class="nx">spc</span><span class="p">.</span><span class="nf">blockchain</span><span class="p">().</span><span class="nf">BestChain</span><span class="p">().</span><span class="nf">GetTicketProductionRandSeed</span><span class="p">(</span><span class="nx">spc</span><span class="p">.</span><span class="nf">blockchain</span><span class="p">().</span><span class="nf">LatestEpoch</span><span class="p">())</span>

	<span class="k">return</span> <span class="nx">ticket</span><span class="p">.</span><span class="nf">Verify</span><span class="p">(</span><span class="nx">randomness1</span><span class="p">,</span> <span class="nx">pk</span><span class="p">,</span> <span class="nx">minerActorAddr</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">spc</span> <span class="o">*</span><span class="nx">StoragePowerConsensusSubsystem_I</span><span class="p">)</span> <span class="nf">ComputeChainWeight</span><span class="p">(</span><span class="nx">tipset</span> <span class="nx">chain</span><span class="p">.</span><span class="nx">Tipset</span><span class="p">)</span> <span class="nx">block</span><span class="p">.</span><span class="nx">ChainWeight</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">spc</span><span class="p">.</span><span class="nf">ec</span><span class="p">().</span><span class="nf">ComputeChainWeight</span><span class="p">(</span><span class="nx">tipset</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">spc</span> <span class="o">*</span><span class="nx">StoragePowerConsensusSubsystem_I</span><span class="p">)</span> <span class="nf">IsWinningPartialTicket</span><span class="p">(</span><span class="nx">stateTree</span> <span class="nx">stateTree</span><span class="p">.</span><span class="nx">StateTree</span><span class="p">,</span> <span class="nx">inds</span> <span class="nx">inds</span><span class="p">.</span><span class="nx">Indices</span><span class="p">,</span> <span class="nx">partialTicket</span> <span class="nx">abi</span><span class="p">.</span><span class="nx">PartialTicket</span><span class="p">,</span> <span class="nx">sectorUtilization</span> <span class="nx">abi</span><span class="p">.</span><span class="nx">StoragePower</span><span class="p">,</span> <span class="nx">numSectors</span> <span class="nx">util</span><span class="p">.</span><span class="nx">UVarint</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>

	<span class="c1">// finalize the partial ticket
</span><span class="c1"></span>	<span class="nx">challengeTicket</span> <span class="o">:=</span> <span class="nx">acrypto</span><span class="p">.</span><span class="nf">SHA256</span><span class="p">(</span><span class="nx">abi</span><span class="p">.</span><span class="nf">Bytes</span><span class="p">(</span><span class="nx">partialTicket</span><span class="p">))</span>

	<span class="nx">networkPower</span> <span class="o">:=</span> <span class="nx">inds</span><span class="p">.</span><span class="nf">TotalNetworkEffectivePower</span><span class="p">()</span>

	<span class="nx">sectorsSampled</span> <span class="o">:=</span> <span class="nb">uint64</span><span class="p">(</span><span class="nx">math</span><span class="p">.</span><span class="nf">Ceil</span><span class="p">(</span><span class="nb">float64</span><span class="p">(</span><span class="nx">node_base</span><span class="p">.</span><span class="nx">EPOST_SAMPLE_RATE_NUM</span><span class="o">/</span><span class="nx">node_base</span><span class="p">.</span><span class="nx">EPOST_SAMPLE_RATE_DENOM</span><span class="p">)</span> <span class="o">*</span> <span class="nb">float64</span><span class="p">(</span><span class="nx">numSectors</span><span class="p">)))</span>

	<span class="k">return</span> <span class="nx">spc</span><span class="p">.</span><span class="nf">ec</span><span class="p">().</span><span class="nf">IsWinningChallengeTicket</span><span class="p">(</span><span class="nx">challengeTicket</span><span class="p">,</span> <span class="nx">sectorUtilization</span><span class="p">,</span> <span class="nx">networkPower</span><span class="p">,</span> <span class="nx">sectorsSampled</span><span class="p">,</span> <span class="nx">numSectors</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">spc</span> <span class="o">*</span><span class="nx">StoragePowerConsensusSubsystem_I</span><span class="p">)</span> <span class="nf">_getStoragePowerActorState</span><span class="p">(</span><span class="nx">stateTree</span> <span class="nx">stateTree</span><span class="p">.</span><span class="nx">StateTree</span><span class="p">)</span> <span class="nx">spowact</span><span class="p">.</span><span class="nx">StoragePowerActorState</span> <span class="p">{</span>
	<span class="nx">powerAddr</span> <span class="o">:=</span> <span class="nx">builtin</span><span class="p">.</span><span class="nx">StoragePowerActorAddr</span>
	<span class="nx">actorState</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">stateTree</span><span class="p">.</span><span class="nf">GetActor</span><span class="p">(</span><span class="nx">powerAddr</span><span class="p">)</span>
	<span class="nx">util</span><span class="p">.</span><span class="nf">Assert</span><span class="p">(</span><span class="nx">ok</span><span class="p">)</span>
	<span class="nx">substateCID</span> <span class="o">:=</span> <span class="nx">actorState</span><span class="p">.</span><span class="nf">State</span><span class="p">()</span>

	<span class="nx">substate</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">spc</span><span class="p">.</span><span class="nf">node</span><span class="p">().</span><span class="nf">Repository</span><span class="p">().</span><span class="nf">StateStore</span><span class="p">().</span><span class="nf">Get</span><span class="p">(</span><span class="nx">cid</span><span class="p">.</span><span class="nf">Cid</span><span class="p">(</span><span class="nx">substateCID</span><span class="p">))</span>
	<span class="nx">util</span><span class="p">.</span><span class="nf">Assert</span><span class="p">(</span><span class="nx">ok</span><span class="p">)</span>

	<span class="c1">// fix conversion to bytes
</span><span class="c1"></span>	<span class="nx">util</span><span class="p">.</span><span class="nf">IMPL_FINISH</span><span class="p">(</span><span class="nx">substate</span><span class="p">)</span>
	<span class="kd">var</span> <span class="nx">serializedSubstate</span> <span class="nx">util</span><span class="p">.</span><span class="nx">Serialization</span>
	<span class="kd">var</span> <span class="nx">st</span> <span class="nx">spowact</span><span class="p">.</span><span class="nx">StoragePowerActorState</span>
	<span class="nx">serde</span><span class="p">.</span><span class="nf">MustDeserialize</span><span class="p">(</span><span class="nx">serializedSubstate</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">st</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">st</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">spc</span> <span class="o">*</span><span class="nx">StoragePowerConsensusSubsystem_I</span><span class="p">)</span> <span class="nf">GetFinalizedEpoch</span><span class="p">(</span><span class="nx">currentEpoch</span> <span class="nx">abi</span><span class="p">.</span><span class="nx">ChainEpoch</span><span class="p">)</span> <span class="nx">abi</span><span class="p">.</span><span class="nx">ChainEpoch</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">currentEpoch</span> <span class="o">-</span> <span class="nx">node_base</span><span class="p">.</span><span class="nx">FINALITY</span>
<span class="p">}</span>
</code></pre></div>




</p>
<h2 id="repeated-leader-election-attempts">Repeated Leader Election attempts</h2>
<p>In the case that no miner is eligible to produce a block in a given round of EC, the storage power consensus subsystem will be called by the block producer to attempt another leader election by incrementing the nonce appended to the ticket drawn from the past in order to attempt to find a new winning <code>PartialTicket</code> and trying again.
Note that a miner may attempt to grind through tickets by incrementing the nonce repeatedly until they find a winning ticket. However, any block so generated in the future will be rejected by other miners (with synchronized clocks) until that epoch&rsquo;s appropriate time.</p>
<div id="systems__filecoin_blockchain__storage_power_consensus__min_miner_size"></div>
<h2 id="minimum-miner-size">Minimum Miner Size</h2>
<p>In order to secure Storage Power Consensus, the system defines a minimum miner size required to participate in consensus.</p>
<p>Specifically, miners must have either at least <code>MIN_MINER_SIZE_STOR</code> of power (i.e. storage power currently used in storage deals) in order to participate in leader election. If no miner has <code>MIN_MINER_SIZE_STOR</code> or more power, miners with at least as much power as the smallest miner in the top <code>MIN_MINER_SIZE_TARG</code> of miners (sorted by storage power) will be able to participate in leader election. In plain english, take <code>MIN_MINER_SIZE_TARG = 3</code> for instance, this means that miners with at least as much power as the 3rd largest miner will be eligible to participate in consensus.</p>
<p>Miners smaller than this cannot mine blocks and earn block rewards in the network. Their power will still be counted in the total network (raw or claimed) storage power, even though their power will not be counted as votes for leader election. However, <strong>it is important to note that such miners can still have their power faulted and be penalized accordingly</strong>.</p>
<p>Accordingly, to bootstrap the network, the genesis block must include miners, potentially just CommittedCapacity sectors, to initiate the network.</p>
<p>The <code>MIN_MINER_SIZE_TARG</code> condition will not be used in a network in which any miner has more than <code>MIN_MINER_SIZE_STOR</code> power. It is nonetheless defined to ensure liveness in small networks (e.g. close to genesis or after large power drops).</p>
<!-- raw HTML omitted -->
<p>We currently set:</p>
<ul>
<li><code>MIN_MINER_SIZE_STOR = 100 * (1 &lt;&lt; 40) Bytes</code> (100 TiB)</li>
<li>`MIN_MINER_SIZE_TARG = 3</li>
</ul>
<h2 id="network-recovery-after-halting">Network recovery after halting</h2>
<p>Placeholder where we will define a means of rebooting network liveness after it halts catastrophically (i.e. empty power table).</p>
</article>

      

      
    </div>

    
  

  <aside class="book-toc level-6 fixed">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#distinguishing-between-storage-miners-and-block-miners">Distinguishing between storage miners and block miners</a></li>
    <li><a href="#on-power">On Power</a></li>
    <li><a href="#tickets">Tickets</a>
      <ul>
        <li><a href="#comparing-tickets-in-a-tipset-and-using-ticket-values">Comparing Tickets in a Tipset and using ticket values</a></li>
      </ul>
    </li>
    <li><a href="#the-ticket-chain-and-drawing-randomness">The Ticket chain and drawing randomness</a>
      <ul>
        <li><a href="#randomness-ticket-generation">Randomness Ticket generation</a></li>
        <li><a href="#ticket-validation">Ticket Validation</a></li>
      </ul>
    </li>
    <li><a href="#repeated-leader-election-attempts">Repeated Leader Election attempts</a></li>
    <li><a href="#minimum-miner-size">Minimum Miner Size</a></li>
    <li><a href="#network-recovery-after-halting">Network recovery after halting</a></li>
  </ul>
</nav>
  </aside>



  </main>

  
  
</body>

</html>
